services:
  feature-producer:
    container_name: hm-occ-feature
    build:
      context: .
      dockerfile: services/feature_producer/Dockerfile
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          python -c "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health')"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      hm-occ:
        aliases:
          - feature-producer

  model-consumer:
    container_name: hm-occ-predict
    build:
      context: .
      dockerfile: services/model_consumer/Dockerfile
    env_file:
      - .env
    environment:
      FEATURE_PRODUCER_FEATURE_ENDPOINT_BASE_URL: ${FEATURE_PRODUCER_FEATURE_ENDPOINT_BASE_URL:-http://feature-producer:8000/api}
    depends_on:
      feature-producer:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test:
        - CMD-SHELL
        - >-
          python -c "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8002/health')"
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - hm-occ
      - traefik
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hm-occ-pred.rule=Host(`occ.fs-mucdai.de`) && PathPrefix(`/api/predictions`)"
      - "traefik.http.routers.hm-occ-pred.entrypoints=https"
      - "traefik.http.routers.hm-occ-pred.tls=true"
      - "traefik.http.services.hm-occ-pred.loadbalancer.server.port=8002"
      - "traefik.http.middlewares.pred-strip.stripprefix.prefixes=/api"
      - "traefik.http.routers.hm-occ-pred.middlewares=pred-strip"
      - "traefik.docker.network=traefik"

networks:
  hm-occ:
    external: true
  traefik:
    external: true